name: ci

on:
  push:
  pull_request:

jobs:
  build-test-linux:
    name: build-test-linux
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup CMake
        uses: lukka/get-cmake@latest

      - name: Configure
        run: cmake -S . -B build -DPOMAI_BUILD_TESTS=ON

      - name: Build
        run: cmake --build build --config Release --parallel

      - name: CTest
        run: ctest --test-dir build --output-on-failure -C Release --timeout 120 -E "recall_test|recovery_test"

  tsan:
    name: tsan-linux
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      # Use GCC (default on Ubuntu) + TSan; POMAI_USE_PALLOC=OFF avoids multiple-definition with TSan's new/delete.
      - name: Configure (TSAN)
        run: >-
          cmake -S . -B build-tsan -DPOMAI_BUILD_TESTS=ON -DPOMAI_BUILD_BENCH=OFF -DPOMAI_USE_PALLOC=OFF
          -DCMAKE_BUILD_TYPE=RelWithDebInfo
          -DCMAKE_C_FLAGS='-fsanitize=thread -fno-omit-frame-pointer -g'
          -DCMAKE_CXX_FLAGS='-fsanitize=thread -fno-omit-frame-pointer -g'
          -DCMAKE_EXE_LINKER_FLAGS='-fsanitize=thread'
          -DCMAKE_SHARED_LINKER_FLAGS='-fsanitize=thread'
      - name: Build (TSAN)
        run: cmake --build build-tsan --parallel
      - name: TSAN workload tests
        run: ctest --test-dir build-tsan --output-on-failure -L tsan --timeout 120

  asan:
    name: asan-linux
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      # GCC + ASan; POMAI_USE_PALLOC=OFF so ASan can intercept allocator.
      - name: Configure (ASan)
        run: >-
          cmake -S . -B build-asan -DPOMAI_BUILD_TESTS=ON -DPOMAI_BUILD_BENCH=OFF -DPOMAI_USE_PALLOC=OFF
          -DCMAKE_BUILD_TYPE=RelWithDebInfo
          -DCMAKE_C_FLAGS='-fsanitize=address -fno-omit-frame-pointer -g'
          -DCMAKE_CXX_FLAGS='-fsanitize=address -fno-omit-frame-pointer -g'
          -DCMAKE_EXE_LINKER_FLAGS='-fsanitize=address'
          -DCMAKE_SHARED_LINKER_FLAGS='-fsanitize=address'
      - name: Build (ASan)
        run: cmake --build build-asan --parallel
      - name: Run tests (ASan)
        run: ctest --test-dir build-asan --output-on-failure -C RelWithDebInfo -E "tsan|crash" --timeout 120

  ubsan:
    name: ubsan-linux
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      # GCC + UBSan; POMAI_USE_PALLOC=OFF so sanitizer runtimes are used.
      - name: Configure (UBSan)
        run: >-
          cmake -S . -B build-ubsan -DPOMAI_BUILD_TESTS=ON -DPOMAI_BUILD_BENCH=OFF -DPOMAI_USE_PALLOC=OFF
          -DCMAKE_BUILD_TYPE=RelWithDebInfo
          -DCMAKE_C_FLAGS='-fsanitize=undefined -fno-omit-frame-pointer -g'
          -DCMAKE_CXX_FLAGS='-fsanitize=undefined -fno-omit-frame-pointer -g'
          -DCMAKE_EXE_LINKER_FLAGS='-fsanitize=undefined'
          -DCMAKE_SHARED_LINKER_FLAGS='-fsanitize=undefined'
      - name: Build (UBSan)
        run: cmake --build build-ubsan --parallel
      - name: Run tests (UBSan)
        run: ctest --test-dir build-ubsan --output-on-failure -C RelWithDebInfo -E "tsan|crash" --timeout 120

  python-ffi-smoke:
    name: python-ffi-smoke
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Configure
        run: cmake -S . -B build -DPOMAI_BUILD_TESTS=ON
      - name: Build shared C ABI
        run: cmake --build build --target pomai_c --parallel
      - name: Run Python ctypes smoke
        run: python3 tests/ffi/python_ctypes_smoke.py
      - name: Run RAG smoke
        run: python3 scripts/rag_smoke.py

  perf-gate:
    name: perf-gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Configure
        run: cmake -S . -B build -DPOMAI_BUILD_TESTS=ON
      - name: Build perf harness
        run: cmake --build build --target ci_perf_bench --parallel
      - name: Run perf guardrail
        run: python3 tools/perf_gate.py --build-dir build --baseline benchmarks/perf_baseline.json --threshold 0.10

  benchmark-trust:
    name: benchmark-trust
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Install Python deps
        run: python3 -m pip install numpy
      - name: Configure
        run: cmake -S . -B build -DPOMAI_BUILD_TESTS=OFF
      - name: Build shared C ABI
        run: cmake --build build --target pomai_c --parallel
      - name: Run trust benchmark gates
        run: scripts/benchmark_trust.sh
