version: '3.8'

services:
  cache-service:
    # Nếu bạn muốn tự build tại chỗ khi deploy:
    # build: . 
    # Hoặc nếu dùng Image đã đẩy lên DockerHub từ GitHub Actions:
    image: autocookies/pomai_server:cache-service
    container_name: pomai-cache # Đặt tên cố định để dễ debug
    restart: unless-stopped

    # Cấu hình biến môi trường
    environment:
      - PORT=8080
      - JWT_ACCESS_SECRET=${JWT_ACCESS_SECRET} # Lấy từ file .env trên server
      - CACHE_SHARDS=64
      - PER_TENANT_CAPACITY_BYTES=52428800 # 50MB
      - GRACEFUL_SHUTDOWN_SEC=10

    # Kết nối vào mạng chung
    networks:
      - pomai-net

    deploy:
      resources:
        limits:
          memory: 512M

# QUAN TRỌNG: Khai báo mạng này là EXTERNAL (đã được tạo từ trước)
networks:
  pomai-net:
    external: true
